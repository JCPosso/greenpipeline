"""
GreenPipeline Carbon Intensity API Client
Integraci√≥n con Electricity Maps y WattTime para datos en tiempo real
"""

import requests
from typing import Optional, Dict
from dataclasses import dataclass
from datetime import datetime
import json


@dataclass
class CarbonIntensityData:
    """Datos de intensidad de carbono"""

    grams_per_kwh: float
    location: str
    timestamp: datetime
    renewable_percent: float
    source: str


class CarbonIntensityAPI:
    """
    Cliente para obtener intensidad de carbono en tiempo real.
    Usa m√∫ltiples fuentes: Electricity Maps, CO2Signal, fallback a promedios.
    """

    # Promedios globales por regi√≥n (g CO2e/kWh) - Fuente: IEA 2024
    REGIONAL_AVERAGES = {
        "US": 389,
        "US-CA": 234,  # California (alta renovable)
        "US-TX": 425,  # Texas
        "EU": 275,
        "DE": 420,  # Alemania
        "FR": 55,  # Francia (nuclear)
        "UK": 233,
        "CN": 555,
        "IN": 632,
        "BR": 82,  # Brasil (hidro)
        "CO": 165,  # Colombia (hidro)
        "GLOBAL": 475,
    }

    def __init__(self, api_key: Optional[str] = None):
        """
        Args:
            api_key: Clave API para Electricity Maps (opcional)
        """
        self.api_key = api_key
        self.session = requests.Session()

    def get_current_intensity(self, location: str = "GLOBAL") -> CarbonIntensityData:
        """
        Obtiene intensidad de carbono actual para una ubicaci√≥n.

        Args:
            location: C√≥digo ISO del pa√≠s/regi√≥n (ej: "US", "DE", "CO")

        Returns:
            CarbonIntensityData con la intensidad actual
        """
        # Intentar API en tiempo real si hay key
        if self.api_key:
            try:
                return self._fetch_from_electricity_maps(location)
            except Exception as e:
                print(f"‚ö†Ô∏è  API fallida, usando promedio: {e}")

        # Fallback a promedios regionales
        return self._get_regional_average(location)

    def _fetch_from_electricity_maps(self, location: str) -> CarbonIntensityData:
        """
        Consulta Electricity Maps API (requiere suscripci√≥n).
        Documentaci√≥n: https://docs.electricitymaps.com/
        """
        url = f"https://api.electricitymap.org/v3/carbon-intensity/latest"
        params = {"zone": location}
        headers = {"auth-token": self.api_key}

        response = self.session.get(url, params=params, headers=headers, timeout=5)
        response.raise_for_status()

        data = response.json()

        return CarbonIntensityData(
            grams_per_kwh=data["carbonIntensity"],
            location=location,
            timestamp=datetime.fromisoformat(data["datetime"].replace("Z", "+00:00")),
            renewable_percent=data.get("renewablePercentage", 0),
            source="ElectricityMaps",
        )

    def _get_regional_average(self, location: str) -> CarbonIntensityData:
        """
        Devuelve promedio regional basado en datos IEA 2024.
        """
        # Normalizar c√≥digo
        location = location.upper()

        # Buscar coincidencia exacta o prefijo
        intensity = None
        for key in self.REGIONAL_AVERAGES:
            if location == key or location.startswith(key):
                intensity = self.REGIONAL_AVERAGES[key]
                break

        if intensity is None:
            intensity = self.REGIONAL_AVERAGES["GLOBAL"]
            location = "GLOBAL"

        return CarbonIntensityData(
            grams_per_kwh=intensity,
            location=location,
            timestamp=datetime.now(),
            renewable_percent=self._estimate_renewable_percent(location),
            source="Regional Average (IEA 2024)",
        )

    def _estimate_renewable_percent(self, location: str) -> float:
        """Estimaci√≥n aproximada de % renovable por regi√≥n"""
        renewable_map = {
            "US-CA": 60,
            "FR": 90,
            "BR": 85,
            "CO": 70,
            "DE": 45,
            "UK": 40,
            "US": 20,
            "GLOBAL": 28,
        }
        return renewable_map.get(location, 28)

    def is_green_window(self, threshold: float = 300) -> bool:
        """
        Determina si es un 'green window' para ejecutar builds.

        Args:
            threshold: Umbral en g CO2e/kWh (default: 300)

        Returns:
            True si la intensidad actual est√° por debajo del umbral
        """
        current = self.get_current_intensity()
        return current.grams_per_kwh < threshold

    def suggest_delay(self, current_location: str = "GLOBAL") -> Optional[Dict]:
        """
        Sugiere si vale la pena retrasar la ejecuci√≥n.

        Returns:
            Dict con sugerencia o None si ejecutar ahora es √≥ptimo
        """
        current = self.get_current_intensity(current_location)

        # L√≥gica simplificada: si estamos > 400 g/kWh, sugerir esperar
        if current.grams_per_kwh > 400:
            return {
                "should_delay": True,
                "current_intensity": current.grams_per_kwh,
                "reason": "Alta intensidad de carbono en la red el√©ctrica",
                "suggestion": "Retrasar 2-4 horas para aprovechar m√°s renovables",
                "potential_saving_percent": 20,
            }

        return None


# Ejemplo de uso
if __name__ == "__main__":
    print("üåç GreenPipeline Carbon Intensity API")
    print("=" * 60)

    # Sin API key (usa promedios)
    api = CarbonIntensityAPI()

    # Probar varias ubicaciones
    locations = ["CO", "US-CA", "DE", "FR", "GLOBAL"]

    for loc in locations:
        data = api.get_current_intensity(loc)

        print(f"\nüìç {data.location}")
        print(f"  Intensidad:  {data.grams_per_kwh} g CO2e/kWh")
        print(f"  Renovables:  ~{data.renewable_percent}%")
        print(f"  Fuente:      {data.source}")

        # Determinar si es "green window"
        is_green = data.grams_per_kwh < 300
        emoji = "‚úÖ" if is_green else "‚ö†Ô∏è"
        print(f"  {emoji} {'Green window' if is_green else 'Consider delaying'}")

    print("\n" + "=" * 60)
    print("üí° Carbon-Aware Scheduling")
    suggestion = api.suggest_delay("DE")

    if suggestion:
        print(f"  ‚è∞ {suggestion['reason']}")
        print(f"  üí° {suggestion['suggestion']}")
        print(f"  üìâ Ahorro potencial: {suggestion['potential_saving_percent']}%")
    else:
        print("  ‚úÖ Momento √≥ptimo para ejecutar - Proceder ahora")

    print("\nüìä Comparaci√≥n de impacto:")
    print("  1000 builds en Alemania (420 g/kWh): ")
    print("    vs Colombia (165 g/kWh) = -61% emisiones")
